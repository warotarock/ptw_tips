# サウンド管理 - Sound management

## 概要
※作成途中です

ソースコード
- [サンプルプログラム（main.ts）](./main.ts)
- [基本クラス、サウンドマネージャ（sound.ts）](../tips_core/sound.ts)
- [HTML5 Audioでの音声再生クラス（sound_html5_audio.ts）](../tips_core/sound_html5_audio.ts)
- [HTML5 WebAudioでの音声再生クラス（sound_html5_webaudio.ts）](../tips_core/sound_html5_webaudio.ts)


## サウンド管理

### Web環境での音声再生

ブラウザ上で音声を再生する方法は、Web標準技術としては２つ存在します。一つはHTMLのAudio要素を利用する方法、もう一つはWebAudioを利用する方法です。Audio要素はより簡単に音声を再生でき、WebAudioはより高度な音声再生処理ができるため、どちらも一長一短といえます。ただし、モバイル環境での音声再生にはブラウザごとに異なる様々な制限が存在します。特にAudio要素はSafariブラウザでの制限が厳しいため、ゲームでの利用を前提とした場合WebAudioを使用することになるのが現状（2017年10月時点）のようです。

### Android環境での音声再生

ゲーム「トリノワールド」では、開発作業の多くはWeb環境で行いましたが、ゲームのリリースはAndroidのネイティブアプリで行いました。そのためWebAudioの代替手段としてSoundPoolを使用しましたが、その際はゲームシステム側から見てWebAudioの場合と同じ挙動をする中間層を用意することで、ゲームシステム側の修正をほとんどすることなく対応することができました。

### マルチプラットフォーム対応の設計

もし、既存のゲームエンジンなどを使わずに様々な環境に対応したゲームシステムを実現したい場合は、ゲームシステムから見て音声再生処理の中核部分は隠蔽されているように最初から設計するとよいでしょう。

サンプルプログラムでは、音声再生処理をデバイスクラスとして抽象化、隠蔽することで、マネージャに与えるデバイスクラスを取り替えるだけでマルチプラットフォーム対応しやすいようにしています。

### 音声再生コントロール

ゲームでは音声の再生と停止以外にも様々な操作を行うことがあります。以下は代表的なものです。

- 音量の調節
- フェードイン・フェードアウト
- パン（左右の音量を別々に変化させる）
- ループ再生

サウンド管理では、音声を再生する単位ごとにこれらの操作を実現することになります。


## サンプルプログラム

### プログラム構成

![](aaa.png)

### デバイスクラス

- 音源ユニット、再生ユニットを生成する
- マスタ音量機能

### 音源ユニットクラス

- 音声データなど、デバイスに依存する音源のリソースを保持する
- 同時再生可能数の再生ユニットを保持する
- １フレーム内での複数再生の開始をしないためのフラグを保持する

### 再生ユニットクラス

- デバイスに依存する再生単位のオブジェクト、ハンドル、ＩＤなどを保持する（Audio要素、AudioBufferSourceNodeなど）
- 再生中のサウンドの状態の取得、操作を行う
  - 音量
  - ポーズ状態
  - ループ再生の状態
  - フェードイン・フェードアウトの状態

### サウンドマネージャクラス

- 再生終了した再生ユニットの回収処理
- フェードイン、フェードアウト処理の実行
- ループ再生処理の実行
- １フレーム内での複数再生の開始をしないためのフラグを解除する


## 関連情報

音声素材：ザ・マッチイメイカァズ　様