# キャンバス描画（文字列描画） - Canvas drawing (for text drawing)

## 概要

キャンバスとWebGLを使った2次元描画についての解説とサンプルプログラムです。ここでは主な文字列の描画を目的とします。

ソースコード

- [サンプルプログラム（main.ts）](./main.ts)
- [２Ｄ描画ラッパークラス（render2d.ts）](../tips_core/render2d.ts)
- [キャンバス描画（canvas_drawer.ts）](../tips_core/canvas_drawer.ts)

![](./canvas_drawing_fig001.png)


## キャンバス描画

### キャンバスによる描画とWebGL

描画処理の中にはWebGLで実現するよりもキャンバス（HTMLのcanvas要素）で実現したほうが簡単なものがあります。たとえば、キャンバスを使用すると直線や曲線、円、グラデーションなどの描画が容易にできます。また文字列の描画はアンチエイリアスの適用された高品質な結果を得られます。

キャンバスの描画結果は画像データとして取り出すことができます。具体的にはキャンバスをWebGLの texSubImage2D関数に渡すことでキャンバスの画像データをWebGLのテクスチャにコピーできます。次のコードはテクスチャにキャンバスの内容をコピーする関数の例です。(参考：[render3d.ts](../tips_core/render3d.ts))

```
setTextureImageFromCanvas(image: RenderImage, canvas: HTMLCanvasElement) {

    var gl = this.gl;

    gl.bindTexture(gl.TEXTURE_2D, image.texture);

    gl.texSubImage2D(gl.TEXTURE_2D, 0, 0, 0, gl.RGBA, gl.UNSIGNED_BYTE, canvas);

    gl.bindTexture(gl.TEXTURE_2D, null);
}
```


### 描画頻度の抑制

キャンバスの大きさにも依存しますが、テクスチャに画像データをコピーする処理は他のWebGLの描画処理と比べ比較的時間のかかる処理です。また、キャンバスによる文字列描画にも時間がかかります。そのためゲームの描画処理ではあらかじめビットマップフォントを用意するなどして高速に文字列を描画する手法が用いられることがあります。

![](./canvas_drawing_fig003.png)

一方で、文字列の内容に変化が無いかぎりは描画を繰り返す必要が無い場合も多くあります。例えば日本語での説明文や、ユーザの入力したプレイヤーキャラクターの名前などです。これらは画面の同じ位置に同じ文字が表示され続けるか、スクロールなどで位置だけが変化する場合がほとんどでしょう。

![](./canvas_drawing_fig004.png)

そのような場合には、文字列が表示される最初の１回と変更があったときだけ文字列の描画処理を行い、結果をWebGLのテクスチャに保存しておくことで描画処理の頻度を軽減することができます。サンプルプログラムではキャンバス描画クラス(CanvasDrawer、TextDrawer、ImageDrawer)にそのための機能が実装されています。


### 文字列描画の位置決めとサイズの計測

現時点（2017年10月）のキャンバスには、文字列を中央寄せなどの位置決めをして描画する機能や日本語の縦書きのための機能はサポートされていません。これらを実現するには文字のサイズを計測し描画位置を調整しながら文字列を描画する必要があります。

キャンバスには描画結果のテキストの幅を取得できる機能（measureText関数）がありますが、縦書きのためのサイズ計測のためには十分ではありません。より正確な文字のサイズを計測するには、現時点では描画結果の画像を解析することになります。これにはブラウザやＯＳなどの実行環境による差異を補正する効果も期待できます。

サンプルプログラムでは、最初に非表示の計測用のキャンバスを用意して基準となる１文字を描画し、getImageData関数で取得したピクセルデータを解析して幅と高さを計測します。そして、より正確に目的のサイズに合うサイズに描画するための倍率や位置のずれを計算します。これは最初の1回だけ行い、以降の描画処理では計算済みの値を用いて描画を行います。サンプルプログラムでは画面下のほうに非表示のキャンバスも表示されるようにしていますので、実行中にキャンバスの内容を確認することができます。

![](./canvas_drawing_fig005.png)

上は計測用のキャンバスの例です。


## サンプルプログラム

### プログラム構成

下の図は文字列と画像(HTMLのImage要素)を最初の入力、WebGLのテクスチャを最後の出力としてクラス間の関係を示しています。実践の四角はクラスの実体、矢印はデータ的な流れの方向を表したものです。処理のほとんどはキャンバスを利用した描画処理を行うキャンバス描画クラス（CanvasDrawer）にあり、その他は補助的なクラスとなっています。

![](./canvas_drawing_fig002.png)


### 処理の流れ

1. CanvasDrawerの初期化
2. 各種ドロワー(TextDrawer、ImageDrawer)をCanvasDrawerに追加
3. ループ処理
    1. （ゲームのメイン処理）
    2. ドロワーのパラメータ変更（再描画フラグにtrueが設定されます）
    3. 再描画処理の実行（再描画フラグにfalseが設定されます）


### キャンバス描画クラス(CanvasDrawer)

キャンバス描画は描画処理を統合して行うクラスです。具体的には以下の機能を持ちます。

- 描画用、計測用のキャンバスの管理
- 各種ドロワーの保持
- 再描画制御
- 描画の実行

描画用、計測用のキャンバスはinitialize関数により作成され、2次元描画コンテキストも同時に取得されます。


### ドロワークラス

- テキストドロワー(VerticalTextDrawer、HorizontalTextDrawer)
- 画像ドロワー(ImageDrawer)

キャンバス描画クラスにはテキストと画像の描画機能があり、それぞれ対応するオブジェクトを表現した(事実上の)内部クラスがあります。これらをドロワーと呼ぶこととします。ドロワーはaddTextDrawer関数、addImageDrawer関数でキャンバス描画に登録すると、登録順に描画されます。

テキストドロワーは文字列を描画するオブジェクトです。縦書き用と横書き用のクラスがそれぞれあります。キャンバス描画に登録する際、文字サイズ計測用の適当な文字列をmearsureSampleLetterプロパティにあらかじめ設定しておくと、より正確な文字のサイズで描画することができます。

画像ドロワーは画像を描画するオブジェクトです。平行移動、拡大縮小、回転、半透明描画が可能です。


### キャンバスレンダークラス(CanvasRender)

HTMLのCanvas要素から取得されるコンテキスト（CanvasRenderingContext2D）のラッパークラスです。また、WebGLとの連携をしやすくするため、フォントのサイズのみを指定して変更する機能や色を数値型の配列で指定する機能などを用意してあります。


### キャンバスコンテキストクラス(CanvasContext)

HTMLのCanvas要素と2次元描画コンテキスト（CanvasRenderingContext2D）をセットで保持するためのクラスです。


## 関連情報

- [TypeScriptによる基本的なWebGLプログラミング](./basic_webgl_ts/)
