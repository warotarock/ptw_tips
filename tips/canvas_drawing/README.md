# キャンバス描画（文字列描画） - Canvas drawing (for text drawing)

## 概要
※作成途中です

文字列の描画など、描画処理の中にはWebGLで実現するよりもキャンバス（HTMLのcanvas要素）で実現したほうが簡単なものがあります。ここでは文字列の描画を主な目的とし、キャンバス描画とWebGLの連携について説明します。

ソースコード

- [サンプルプログラム（main.ts）](./main.ts)
- [２Ｄ描画ラッパークラス（render2d.ts）](../tips_core/render2d.ts)
- [キャンバス描画（canvas_drawer.ts）](../tips_core/canvas_drawer.ts)

![](./canvas_drawing_fig001.png)

## キャンバス描画

### キャンバスによる描画とWebGL

キャンバスを使用すると様々な２次元の描画処理が行えます。たとえば直線や曲線、円、グラデーションなどの描画が可能です。また文字列の描画はアンチエイリアスの適用された高品質な結果を得られます。

キャンバスの描画結果は画像データとして取り出すことができます。具体的にはキャンバスをWebGLの texSubImage2D関数に渡すことでキャンバスの画像データをWebGLのテクスチャにコピーできます。次のコードはテクスチャにキャンバスの内容をコピーする関数の例です。(参考：[render3d.ts](../tips_core/render3d.ts))

```
setTextureImageFromCanvas(image: RenderImage, canvas: HTMLCanvasElement) {

    var gl = this.gl;

    gl.bindTexture(gl.TEXTURE_2D, image.texture);

    gl.texSubImage2D(gl.TEXTURE_2D, 0, 0, 0, gl.RGBA, gl.UNSIGNED_BYTE, canvas);

    gl.bindTexture(gl.TEXTURE_2D, null);
}
```


### 描画頻度の抑制

キャンバスの大きさにも依存しますが、テクスチャに画像データをコピーする処理は他のWebGLの描画処理と比べ比較的時間のかかる処理です。また、キャンバスによる文字列描画にも時間がかかります。そのためゲームの描画処理ではあらかじめビットマップフォントを用意するなどして高速に文字列を描画する手法が用いられることがあります。

![](./canvas_drawing_fig003.png)

一方で、文字列の内容に変化が無いかぎりは描画を繰り返す必要が無い場合も多くあります。例えば日本語での説明文や、ユーザの入力したプレイヤーキャラクターの名前などです。これらは画面の同じ位置に同じ文字が表示され続けるか、スクロールなどで位置だけが変化する場合がほとんどでしょう。

![](./canvas_drawing_fig004.png)

そのような場合には、文字列が表示される最初の１回と変更があったときだけ描画処理を行い、結果をWebGLのテクスチャに保存しておくことで文字列の描画処理の頻度を軽減することができます。サンプルプログラムではキャンバス描画(CanvasDrawer)にそのための機能が実装されています。


### 文字列描画の位置決めとサイズの計測

現時点（2017年10月）のキャンバスには、文字列を中央寄せなどの位置決めをして描画する機能や日本語の縦書きのための機能はサポートされていません。これらを実現するには文字のサイズを計測し描画位置を調整しながら文字列を描画する必要があります。

キャンバスには描画結果のテキストの幅を取得できる機能（measureText関数）がありますが、縦書きのためのサイズ計測には向かない場合があります。より正確な文字のサイズを計測するには、現時点では描画結果の画像を解析することになります。これにはブラウザやＯＳなどの実行環境による差異を補正する効果も期待できます。

サンプルプログラムでは、最初にオフスクリーン用のキャンバスを用意し、基準となる１文字を計測して得られた幅と高さで以降の描画処理を行います。

![](./canvas_drawing_fig005.png)

## サンプルプログラム

### プログラム構成

![](./canvas_drawing_fig002.png)



### 描画頻度の抑制

例としてテキストを描画するためのクラスであるTextDrawerのsetText関数を次に示します。

```
setText(text: string) {

    if (text == this.text) {

        return;
    }

    this.text = text;

    this.setRedraw();
}
```






## 関連情報
- [TypeScriptによる基本的なWebGLプログラミング](./basic_webgl_ts/)
