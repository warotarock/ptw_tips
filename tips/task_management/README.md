# タスク管理 - Task management

## 概要
ゲーム内の様々な動きを制御するタスクとその管理についての説明です。  

ソースコード
- [サンプルコード（main.ts）](./main.ts)
- [タスクマネージャ（game_task_manager.ts）](../tips_core/game_task_manager.ts)
- [タスク実行環境変数（game_task_environment.ts）](../tips_core/game_task_environment.ts)


### タスク管理
「トリノワールド」に登場するキャラクターやオブジェクトは、自分の役割によって自律的に動いているように見えます。また、時系列のあるイベントなど目に見えない現象についても、自律的に動作するものがあります。
しかもこれらは様々なバリエーションが存在します。

ここで紹介するタスク管理のプログラムは、このような自律的に動いたりバリエーションが複数あるものをオブジェクト指向のプログラミング手法で実現するものです。

なお、各種の単語は概ね以下のような意味で使っています。

|単語|説明|
|:-|:-|
|タスク|自律的に動く単位となるもの、その実装の単位となるクラス|
|タスクシステム|タスクという概念を実現するシステムまたはアルゴリズム|
|タスク管理|タスクを整理された方法でうまく扱うこと|
|タスクマネージャ|タスク管理を実装したもの|


### タスクとそのクラスの実装
ゲーム「トリノワールド」ではTypeScriptのクラスの機能を利用してタスクを実装しました。

```
タスクベースクラス
　-> コントローラ
　　-> シーン制御タスク
　　-> メニュー遷移制御タスク
　　-> ＵＩ制御タスク
　　　-> パネル、ボタン、テキストなど

　-> 描画オブジェクト
　　-> 背景オブジェクト
　　-> 敵機
　　　-> ザコ、ボス -> ステージごとの敵機
　　-> 弾
　　　-> 味方弾、敵弾 -> 通常弾、球弾などの各種弾
　　-> エフェクト
　　　-> 爆発、グローなどの各種エフェクト

　※->は左側が親、右側が子の継承関係にあることを表しています
　※自機本体はタスクを使わずに実装
```

例えば弾であれば、ベースとなる「弾」クラスは基本的な弾としての機能（目標に向かって飛んでいく等）を持ちます。見た目は単純な弾の形でアニメーションはありません。その子クラスである「通常弾」クラス、「球弾」クラスでは、コーティングにより見た目とアニメーションだけを変えています。

サンプルプログラムではこれらよりも継承関係は単純ですが、同様の考え方でクラスを設計してあります。これについては後の項目で説明します。

### タスクシステムと他のサブシステムの位置関係
タスクシステムは他のサブシステムとメインシステムの中間に位置します。
他のサブシステムを制御したり利用したりする立場であるとともに、
メインシステムから制御されたり利用されたりする立場にあるからです。

（図を入れる予定）

そのためプログラムの設計は、タスクシステムより下層のサブシステムが
タスクシステムへの参照を持たないように注意して設計されるべきでしょう。
そのような設計にしておくことで、プログラムは木構造の参照関係を持つことになり、
多くの場合、プログラマはシステムのどこで何が起きうるかを把握しやすくなります。

また、プログラミング言語によっては相互参照が許されておらず、実装不可能な場合もあります。


### タスク実行環境変数 - 参照可能範囲の管理
タスクはできるだけ、必要最小限の変数や関数だけを参照できるように設計すべき
であると考えています。そのため、タスクにはタスク実行環境変数（TaskEnvironment）という変数だけを与えて実行しています。

サンプルプログラムでは簡単のために実行環境変数に他のサブシステム（WebGLRenderなど）への参照を単純に持たせていますが、理想としては、他のサブシステムの一部の機能だけを利用可能なクラスだけを持たせるべきでしょう。

例）
```
class RenderTaskEnv {

  private render: WebGLRender;　\\ privateのため外部からアクセス不可
	
  constructor(render: WebGLRender) {

    this.render = render;
  }

  setCulling(enable: boolean) {
    this.render.setCulling(enable);
  }

  ...
}
```


### サンプルプログラム

![test](task_management_figure01.png)

サンプルプログラムでは描画オブジェクト制御するタスクを実装しています。
タスクは次のような継承関係を持ちます。

```
Game.TaskClass
　-> RenderObjectTask
　　-> SampleTask1
　　　-> SampleTask2
```

- Game.TaskClass：全てのタスクのベースクラス、再利用管理の機能を提供する
- RenderObjectTask：開始時に描画オブジェクトを作成し、終了時に破棄するタスク
- SampleTask1：最終的な実装クラスの例１。上昇するキューブ。
- SampleTask2：最終的な実装クラスの例２。回転するキューブ。


## 関連情報
- [オブジェクト・プーリング（再利用管理）](../object_pooling/)
- [モデルの描画](../basic_model_drawing/)
- [描画オブジェクト管理](../render_object_management/)
