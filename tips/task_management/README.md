# タスク管理 - Task management

## 概要
ゲーム内の様々な動きを制御するタスクとその管理についての説明です。  

[サンプルコード main.ts](./main.ts)

### タスクシステム
「トリノワールド」に登場するキャラクターやオブジェクトは、自分の役割や意志によって
自律的に動いているように見えます。
また、時系列のあるイベントなど目に見えない現象についても、自律的に動作するものがあります。
しかもこれらは、たった１種類ではなく様々なバリエーションが存在します。

ここで紹介するタスクシステムは、このような自律的に動いたりバリエーションが複数あるものを
オブジェクト指向のプログラミング手法で実現しようとしたものです。

なお、各種の単語は概ね以下のような意味で使っています。

- タスク：自律的に動く単位となるもの、その実装の単位となるクラス
- タスクシステム：タスクという概念を使ったシステム
- タスク管理：タスクシステム、タスクをうまく使うこと全般を指す
- タスクマネージャ：タスクシステムを実装したもの


### タスク
ゲーム「トリノワールド」ではTypeScriptのクラスの機能を利用してタスクを実装しました。
タスクのクラスには、大きく分けて次のようなクラスが存在しました。

タスクベースクラス  
　-> コントローラ  
　　-> シーン制御タスク  
　　-> メニュー遷移制御タスク  
　　-> ＵＩ制御タスク -> パネル、ボタン、テキストなど  

　-> 描画オブジェクト  
　　-> 背景オブジェクト  
　　-> 敵機 -> ザコ、ボス -> ステージごとの敵機  
　　-> 弾 -> 味方弾、敵弾 -> 通常弾、球弾などの各種弾  
　　-> エフェクト -> 爆発、グローなどの各種エフェクト  

　※->は左側が親、右側が子の継承関係にあることを表しています  
　※自機本体はタスクを使わずに実装

PTWTipsもTypeScriptでプログラムを記述しています。
サンプルプログラムでは、同様の考え方で、いくらか簡略化した実装をしています。


### タスクシステムと他のサブシステムの関係性
タスクシステムは他のサブシステムとメインシステムの中間に位置します。
他のサブシステムを制御したり利用したりする立場であるとともに、
メインシステムから制御されたり利用されたりする立場にあるからです。

（図を入れる予定）

そのためプログラムの設計は、タスクシステムより下層のサブシステムが
タスクシステムへの参照を持たないように注意して設計されるべきでしょう。
そのような設計にしておくことで、プログラムは木構造の参照関係を持つことになり、
多くの場合、プログラマはシステムのどこで何が起きうるかを把握しやすくなります。

また、プログラミング言語によっては相互参照が許されておらず、実装不可能な場合もあります。


### タスクの参照可能範囲
タスクはできるだけ、必要最小限の変数や関数だけを参照できるように設計すべき
であると考えています。
そのため、タスクにはTaskEnvironmentという型の変数だけを与えて実行しています。

サンプルプログラムでは簡単のためにTaskEnvironmentに他のサブシステム（WebGLRenderなど）への
参照を単純に持たせていますが、理想としては、他のサブシステムの一部の機能だけを利用可能な
クラスだけを持たせるべきでしょう。


### サンプルプログラムについて
サンプルプログラムでは描画オブジェクト制御するタスクを実装しています。
タスクは次のような継承関係を持ちます。

TaskClass -> RenderObjectTask -> SampleTask1 -> SampleTask2

- TaskClass：全てのタスクのベースクラス。再利用可能。
- RenderObjectTask：タスク開始時に描画オブジェクトを作成し、終了時に破棄するタスク
- SampleTask1：最終的な実装クラスの例１
- SampleTask1：最終的な実装クラスの例２


## 関連情報
- [オブジェクト・プーリング（再利用管理）](../object_pooling/)
- [モデルの描画](../basic_model_drawing/)
- [描画オブジェクト管理](../render_object_management/)
