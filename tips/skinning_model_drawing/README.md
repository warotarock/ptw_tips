# スキンモデルの描画 - Skin model drawing

## 概要

スキンモデルの描画処理です。ここで使用するモデルデータは[スキンモデルデータの作成](./skinning_model_converting/)で作成したものです。

なお、このサンプルではボーンのアニメーションは計算で生成しています。アニメーションデータはありません。

ソースコード

- [サンプルプログラム（main.ts）](./main.ts)  
- [アニメーション（animation.ts）](../tips_core/animation.ts)  

デモの実行

- [Live Demo](https://warotarock.github.io/ptw_tips/tips/skinning_model_drawing/)

![](skin_model_drawing_fig001.png)


## スキンモデルの描画処理

### パーツ分割済みスキンメッシュモデル

使用するモデルデータはパーツ分割済みスキンメッシュモデルです。このモデルは２つまたは４つのボーンとマテリアルの組み合わせごとにパーツ分けされています。そのため、ひとつのモデルを描画するには全てのパーツごとに描画を繰り返します。

なおボーンが１つや３つの場合は、モデルデータを作成する時点でウェイト値が0のボーンを一つ追加して２つまたは４つになるようにしています。

下の図は３つのボーンを持つモデルの、パーツごとの描画のイメージです。左から、モデル全体、灰色のマテリアルでボーン１と２の影響を受けるパーツ、灰色のマテリアルで全てのボーンの影響を受けるパーツ、赤色のマテリアルでボーン２と３の影響を受けるパーツとなっています。

![](skin_model_drawing_fig004.png)

### モデルデータ

モデルには複数のパーツとボーン情報が含まれます。そしてパーツにはマテリアルやボーン、頂点情報などパーツごとの描画に必要な情報が含まれています。

パーツのフォーマットは次の通りです。

|  |内容                        |フォーマット|
|-:|:---------------------------|:-----------|
| 1|マテリアルのインデクス|int|
| 2|ボーンのインデクス|int|
| 3|１頂点のサイズ（floatの個数）|int|
| 4|頂点データの配列|頂点データ * 頂点数|
| 5|面頂点インデクスの配列|int * 3 * 面数|

ボーンが１つまたは２つの頂点データのフォーマットは次の通りです。

|  |内容                        |フォーマット|
|-:|:---------------------------|:-----------|
| 1|ボーン１のウェイト値<br />ボーン１上の頂点位置 x, y, z<br />ボーン１上の頂点法線 x, y, z|float<br />float * 3<br />float * 3|
| 2|ボーン２のウェイト値<br />ボーン２上の頂点位置 x, y, z<br />ボーン２上の頂点法線 x, y, z|float<br />float * 3<br />float * 3|
| 3|テクスチャ座標 u, v         |float * 2 * UVマップの数|

ボーン４つの頂点データのフォーマットは次の通りです。

|  |内容                        |フォーマット|
|-:|:---------------------------|:-----------|
| 1|ボーン１のウェイト値<br />ボーン１上の頂点位置 x, y, z<br />ボーン１上の頂点法線 x, y, z|float<br />float * 3<br />float * 3|
| 2|ボーン２のウェイト値<br />ボーン２上の頂点位置 x, y, z<br />ボーン２上の頂点法線 x, y, z|float<br />float * 3<br />float * 3|
| 3|ボーン３のウェイト値<br />ボーン３上の頂点位置 x, y, z<br />ボーン３上の頂点法線 x, y, z|float<br />float * 3<br />float * 3|
| 4|ボーン４のウェイト値<br />ボーン４上の頂点位置 x, y, z<br />ボーン４上の頂点法線 x, y, z|float<br />float * 3<br />float * 3|
| 5|テクスチャ座標 u, v         |float * 2 * UVマップの数|


ボーンのフォーマットは次のようになります。ルートのボーンの場合、親ボーンのインデクスは-1となります。

|  |内容                |フォーマット|
|:-|:-------------------|:-----------|
|1|ボーン名             |string      |
|2|親ボーンのインデクス |int         |
|3|ボーン行列           |float * 16  |

※このサンプルでは法線の情報は使用せずに描画を行います。そのためシェーダクラスでバッファの設定を行う際にスキップされるように設定しています。

## サンプルプログラム

### プログラム構成

![プログラムの構成](skin_model_drawing_fig002.png)

上の図はクラスと関数の呼び出し関係を表しています。なお描画に関する基本的な部分は省略しています（参考：[TypeScriptによる基本的なWebGLプログラミング](./basic_webgl_ts/)）。

まずloadSkinModel関数によリスキンモデルのロードが開始され、ロードが終わるとrun関数とdraw関数でメイン処理と描画処理が行われるようになります。

メイン処理ではcalcBoneMatrix関数が呼び出され、ボーンのアニメーション処理とボーン行列の計算が行われます。なお、このサンプルプログラムではアニメーションのデータは計算で生成しています。

描画処理ではdrawSkinModel関数が呼び出され、スキンモデルと計算済みのボーン行列を使用してパーツごとの描画が実行されます。パーツの描画ではボーンの数によりシェーダを切り替えて使用します。ボーンが２つであればBone2Shader、４つであればBone4Shaderを使用します。そしてシェーダに対応する個数のボーンの行列を設定して描画を行います。


### 処理の流れ

おおまかな流れはスタティックモデルの場合と同様です。

1. 初期化処理とロードの開始 (initialize関数)
2. 読み込み処理ループ (processLoading関数)
4. 読み込み後処理 (processLoading関数)
5. メイン処理 (run関数)
6. 描画処理 (draw関数)


## クラスの解説

### SkinModel (main.ts)

読み込み処理のため、スキンモデルのデータに読み込み済みフラグを付け加えたクラスです。


### Bone2Shader、Bone4Shader (main.ts)

シェーダクラスです。


## 関連情報

- [スキンモデルデータの作成](./skinning_model_converting/)
- [スキンモデルのアニメーションデータの作成](./skin_model_animation_converting/)
- [スキンモデルのアニメーションの再生](../skin_model_animation_playing/)

