# スキンモデルデータの作成 - Skinning model data converting

## 概要

※作成途中です

スキンモデルのコンバート処理です。

Collada形式(.dae)のファイルからモデル情報を抽出し、json形式(.json)で出力します。
.daeファイルのパースにはThree.jsのColladaLoaderを利用しています。

ソースコード

- [サンプルプログラム（main.ts）](./main.ts)  
- [モデルのコンバート処理（model_converters.ts）](../tips_core/model_converters.ts)


## コンバート処理

### 目的のモデルデータ

コンバート処理の結果として得られるモデルデータは、頂点ごとに４つまでのボーンとの関連を持つことができ、ボーンの動きに合わせて変形して描画することができるモデルデータ。以降はこのモデルデータのモデルをスキンメッシュモデルと呼びます。

なお、テクスチャをはじめとするマテリアルに関する情報はプログラム側で指定することとし、モデルデータには含めません。

### 入力ファイルの準備

[モデルデータの作成](./basic_model_converting/)と同様にBlenderから標準のエクスポータでdaeファイルを作成します。エクスポートの設定は同じですが、以下の点に注意してください。

- このサンプルではスキンモデルだけを出力します。ウェイトが設定されているメッシュとアーマチュアが必要です。

- メッシュに頂点グループが存在するボーンだけが出力されます（エクスポータの仕様）。ウェイトを割り振らないボーンに対しても頂点グループが必要です。

- ファイルのエクスポート時は、Armatureのポーズの状態により、正しくボーンの状態が再現できない場合があるようです。アニメーションの最初のフレームなどにデフォルトのポーズを保存しておくなどして、Armatureが動いていない状態でエクスポートを実行すると改善されるかもしれません。


### 入力データ

ColladaLoaderの返すオブジェクトがコンバート処理のの実質的な入力データとなります。

以下にColladaLoaderの返すオブジェクトのおおまかな構造を示します。ここで\{ \}はオブジェクト、[]は配列を表しています。このオブジェクトがサンプルプログラムの入力データとなります。

```
(ColladaLoaderの返すオブジェクト)
  dae{}
    geometries{}
      mesh{}
        geometry3js{}
          vertices[]      頂点の座標
          faces[]         面の頂点インデクス
          faceVertexUvs[] 面の頂点UV
          bones[]         ボーン情報
          skinIndices[]   頂点ごとの関連するボーン(ボーンの最大数は４つまででx, y, z, wにボーンのインデクスが保存されています)
          skinWeights[]   頂点ごとの関連するボーンのウェイト値(同上)
```


### 出力するモデルの構造

モデルは２つまたは４つのボーンとマテリアルの組み合わせごとにパーツ分けします。頂点データには、関連するボーンごとにボーンのローカル座標での位置とウェイト値を出力します。関連するボーンが１つまたは３つの頂点は、ウェイト値が0のボーンがもう一つある状態として扱います。

モデルにはボーンの情報も出力します。

ボーンが１つまたは２つの頂点データのフォーマットは次のようになります。

|  |内容                        |フォーマット|
|-:|:---------------------------|:-----------|
| 1|ボーン１のウェイト値<br />ボーン１上の頂点位置 x, y, z<br />ボーン１上の頂点法線 x, y, z|float<br />float * 3<br />float * 3|
| 2|ボーン２のウェイト値<br />ボーン２上の頂点位置 x, y, z<br />ボーン２上の頂点法線 x, y, z|float<br />float * 3<br />float * 3|
| 3|テクスチャ座標 u, v         |float * 2 * UVマップの数|

ボーン４つの頂点データのフォーマットは次のようになります。

|  |内容                        |フォーマット|
|-:|:---------------------------|:-----------|
| 1|ボーン１のウェイト値<br />ボーン１上の頂点位置 x, y, z<br />ボーン１上の頂点法線 x, y, z|float<br />float * 3<br />float * 3|
| 2|ボーン２のウェイト値<br />ボーン２上の頂点位置 x, y, z<br />ボーン２上の頂点法線 x, y, z|float<br />float * 3<br />float * 3|
| 3|ボーン３のウェイト値<br />ボーン３上の頂点位置 x, y, z<br />ボーン３上の頂点法線 x, y, z|float<br />float * 3<br />float * 3|
| 4|ボーン４のウェイト値<br />ボーン４上の頂点位置 x, y, z<br />ボーン４上の頂点法線 x, y, z|float<br />float * 3<br />float * 3|
| 5|テクスチャ座標 u, v         |float * 2 * UVマップの数|


ボーンのフォーマットは次のようになります。ルートのボーンは親ボーンのインデクスに-1を出力します。

|  |内容                |フォーマット|
|:-|:-------------------|:-----------|
|1|ボーン名             |string      |
|2|親ボーンのインデクス |int         |
|3|ボーン行列           |float * 16  |


### 出力ファイル

以下に出力するJSONファイルの構造を示します。

```
{
  "skin_models": {
    "モデル名": {
      "bones": [
        {
          "name": "ボーン名",
          "parent": 親ボーンのインデクス,
          "matrix": [ボーン行列]
        }
      ],
      "parts": [
        {
          "bone": [ボーンのインデクス(２つまたは４つ)],
          "material": マテリアルのインデクス,
          "vertexStride": １頂点のサイズ,
          "vertex": [頂点データ(インターリーブ配列)],
          "index": [面の頂点インデクス]
        }
      ]
    }
  }
}
```


## サンプルプログラム

### プログラム構成

![プログラムの構成](skin_model_converting_fig001.png)

上の図はクラス間の呼び出し関係を表しています。コンバート処理は画面のロード時に実行されるMainクラスのexecute関数で行われます。コンバート処理では、まずThree.jsのColladaLoaderのload関数でファイルを読み込み、その後コンバート処理の各ステップを実行します。

### コンバート処理の３段階

[モデルデータの作成](./basic_model_converting/)と同様に以下の３段階でコンバート処理を行います。

1. ファイルのパース  
2. 必要データの抽出と再構成  
3. 出力 

### コンバート処理の流れ

![コンバート処理の流れ](skin_model_converting_fig002.png)

上の図はデータとそれを処理する関数の関係を表しています。左側はデータのクラスやファイル、右側は処理を行うクラスと関数です。

これら全ての処理はMainクラスのexecute関数で行われます。それぞれの関数で行う処理の詳細については、ソースコードを参照してください。


## 使用外部ライブラリ

- THREE.js, colladaLoader.js
- Linq.js (Enumerable)


## 関連情報

- [モデルデータの作成](./basic_model_converting/)
