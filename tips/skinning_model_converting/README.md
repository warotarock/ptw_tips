# スキンモデルデータの作成 - Skinning model data converting

## 概要

※作成途中です

スキンモデルのコンバート処理です。

Collada形式(.dae)のファイルからモデル情報を抽出し、json形式(.json)で出力します。
.daeファイルのパースにはThree.jsのColladaLoaderを利用し、一部で[BlendFileReader.ts](../blend_file_reader_sample/)も使用しています。

ソースコード

- [サンプルプログラム（main.ts）](./main.ts)  
- [モデルのコンバート処理（model_converters.ts）](../tips_core/model_converters.ts)


## コンバート処理

### 入力ファイルの作成

[モデルデータの作成](./basic_model_converting/)と同様にBlenderから標準のエクスポータでdaeファイルを作成します。エクスポートの設定は同じですが、以下の点に注意してください。

- このサンプルではスキンモデルだけを出力します。ウェイトが設定されているメッシュとアーマチュアが必要です。

- メッシュに頂点グループが存在するボーンだけが出力されます（エクスポータの仕様）。ウェイトを割り振らないボーンに対しても頂点グループが必要です。

- ファイルのエクスポート時は、Armatureのポーズの状態により、正しくボーンの状態が再現できない場合があるようです。アニメーションの最初のフレームなどにデフォルトのポーズを保存しておくなどして、Armatureが動いていない状態でエクスポートを実行すると改善されるかもしれません。


### 入力データ

daeファイル内のモデル情報はBlenderのMeshとArmatureを元にしてdaeファイルの構造に変換され出力されています。さらに、Three.jsのColladaLoaderはファイルを解析し、Three.jsのジオメトリの形式に変換します。

以下にColladaLoaderの返すオブジェクトのおおまかな構造を示します。ここで\{ \}はオブジェクト、[]は配列を表しています。このオブジェクトがサンプルプログラムの入力データとなります。

```
(ColladaLoaderの返すオブジェクト)
  dae{}
    geometries{}
      mesh{}
        geometry3js{}
          vertices[]      頂点の座標
          faces[]         面の頂点インデクス
          faceVertexUvs[] 面の頂点UV
          bones[]         ボーン情報
          skinIndices[]   頂点ごとの関連するボーン(ボーンの最大数は４つまででx, y, z, wにボーンのインデクスが保存されています)
          skinWeights[]   頂点ごとの関連するボーンのウェイト値(同上)
```


### 出力するモデルの構造

モデルは２つまたは４つのボーンとマテリアルの組み合わせごとにパーツ分けします。頂点データには、ボーンごとにウェイト値とボーンのローカル座標での位置を出力します。関連するボーンが１つまたは３つの頂点は、ウェイト値が0のボーンがもう一つある状態として扱います。

ＵＶ座標も出力します。複数ＵＶマップが存在する場合は複数のＵＶが出力されます。ＵＶマップの順番はBlenderのマテリアルに設定されているテクスチャの順番になります。

ボーンが１つまたは２つの頂点データのフォーマットは次のようになります。

|  |内容                        |フォーマット|
|-:|:---------------------------|:-----------|
| 1|ボーン１のウェイト値        |float       |
| 2|ボーン１上の頂点位置 x, y, z|float * 3   |
| 3|ボーン１上の頂点法線 x, y, z|float * 3   |
| 4|ボーン２のウェイト値        |float       |
| 5|ボーン２上の頂点位置 x, y, z|float * 3   |
| 6|ボーン２上の頂点法線 x, y, z|float * 3   |
| 7|UV座標 u, v                 |float * 2 * UVマップの数|

ボーン４つの頂点データのフォーマットは次のようになります。

|  |内容                        |フォーマット|
|-:|:---------------------------|:-----------|
| 1|ボーン１のウェイト値        |float       |
| 2|ボーン１上の頂点位置 x, y, z|float * 3   |
| 3|ボーン１上の頂点法線 x, y, z|float * 3   |
| 4|ボーン２のウェイト値        |float       |
| 5|ボーン２上の頂点位置 x, y, z|float * 3   |
| 6|ボーン２上の頂点法線 x, y, z|float * 3   |
| 7|ボーン３のウェイト値        |float       |
| 8|ボーン３上の頂点位置 x, y, z|float * 3   |
| 9|ボーン３上の頂点法線 x, y, z|float * 3   |
|10|ボーン４のウェイト値        |float       |
|11|ボーン４上の頂点位置 x, y, z|float * 3   |
|12|ボーン４上の頂点法線 x, y, z|float * 3   |
|13|UV座標 u, v                 |float * 2 * UVマップの数|

### 出力ファイルの構造

以下に出力するJSONファイルの構造を示します。ここで\{ \}はオブジェクト、[]は配列を表しています。

```
(JSON root{})
  skin_models{}
    (SkinningModel{})
      images[]        画像のファイル名のリスト
    
      bones[]         ボーン情報のリスト
        (SkinningModelBoneData{})
          name          ボーンの名前
          parent        親ボーンのインデクス
          matrix[]      ボーン行列
    
      parts[]         パーツ情報のリスト
        (SkinningModelPartData{})
          bone          パーツのボーンのインデクス(最大４つまで)
          material      マテリアルのインデクス
          vertexStride  １頂点のサイズ(float型の個数)
          vertex[]      頂点データ(インターリーブ配列)
          index[]       面の頂点インデクス
```


## サンプルプログラム

### プログラム構成

![プログラムの構成](basic_model_converting_fig001.png)

サンプルプログラムは画面のロード時に実行されます。メイン処理はMainクラスのexecute関数です。メイン処理ではまずThree.jsのColladaLoaderのload関数でファイルを読み込み、コンバート処理の各ステップを実行します。

### コンバート処理の流れ１ (ファイルのパースまで)

ここではファイルのパースの段階で行う処理の流れを説明します。なお、パーツ分割済みモデルデータの作成処理についてはソースコードを参照してください。

Main.execute関数

1. ColladaLoaderによるdaeファイルのロード
2. ロード終了イベント
    1. *パースを実行(ThreeJSColladaParser.parse関数)*
    2. 必要データの抽出と再構成の実行(Main.convert関数)
    3. 出力の実行(Main.output関数)

*ThreeJSColladaParser.parse関数*

1. 結果オブジェクト(SceneData)の作成
2. すべての固定モデルのパース ([モデルデータの作成](./basic_model_converting/))を参照してください
3. すべてのスキンモデルのパース (parseSkinGeometries関数)
4. ループ：(ロード結果のオブジェクト).dae.geometries
5. 　スキンモデルでなければスキップ (isSkinGeometry関数で判定)
6. 　*スキンモデルのパース (parseSkinGeometry関数)*
7. 　結果オブジェクトに固定モデルを追加
8. ループ終了
9. 結果オブジェクトを返却

*ThreeJSColladaParser.parseSkinGeometries関数*

1. geometry3jsから頂点データを抽出
2. geometry3jsから面データを抽出
3. 面データのテクスチャ座標情報を頂点データにコピー
4. geometry3jsからボーンデータを抽出
5. パーツ分割済みモデルデータの作成
6. モデル名（メッシュ名）の抽出
7. パーツ分割済みモデルデータを返却

### コンバート処理の流れ２ (必要データの抽出と再構成)

### コンバート処理の流れ３ (出力)

## 使用外部ライブラリ

- THREE.js, colladaLoader.js
- Linq.js (Enumerable)


## 関連情報

- [モデルデータの作成](./basic_model_converting/)
